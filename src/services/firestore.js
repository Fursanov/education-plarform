import {db} from "./firebase";
import {
    addDoc,
    collection,
    doc,
    getDoc,
    getDocs,
    onSnapshot,
    orderBy,
    query,
    serverTimestamp,
    setDoc,
    updateDoc,
    where,
    limit
} from "firebase/firestore";

export const getUserById = async (uid) => {
    const docRef = doc(db, 'users', uid);
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
};


// Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
export const addUser = async (uid, email, role, name) => {
    await setDoc(doc(db, "users", uid), {
        email,
        role,
        name,
        courses: []
    });
};

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
export const getUser = async (uid) => {
    const docRef = doc(db, "users", uid);
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? docSnap.data() : null;
};

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
export const getAllUsers = async () => {
    const querySnapshot = await getDocs(collection(db, "users"));
    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};

// Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ‡Ð°Ñ‚Ð¾Ð¼
export const getChatMessages = (courseId, callback) => {
    const q = query(
        collection(db, `courses/${courseId}/messages`),
        orderBy("timestamp")
    );
    return onSnapshot(q, (snapshot) => {
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(messages);
    });
};

export const sendChatMessage = async (courseId, message) => {
    await addDoc(collection(db, "courses", courseId, "messages"), {
        ...message,
        timestamp: serverTimestamp()
    });
};

export const markMessagesAsRead = async (courseId, userId) => {
    const userRef = doc(db, 'users', userId);
    await updateDoc(userRef, {
        [`lastReadChatTimes.${courseId}`]: new Date()
    });
};

export const updateUser = async (userId, data) => {
    await setDoc(doc(db, 'users', userId), data, { merge: true });
};

export const getChatParticipants = async (courseId) => {
    try {
        // 1. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÐºÑƒÑ€ÑÐµ
        const courseRef = doc(db, 'courses', courseId);
        const courseSnap = await getDoc(courseRef);

        if (!courseSnap.exists()) {
            console.log('Course not found');
            return [];
        }

        const courseData = courseSnap.data();

        // 2. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²: Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ + ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ‹
        const participantsIds = [
            courseData.teacherId, // Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ
            ...(courseData.students || []) // Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²
        ].filter(id => id); // ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ undefined/null

        // 3. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ (Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ teacherId ÐµÑÑ‚ÑŒ Ð² students)
        const uniqueIds = [...new Set(participantsIds)];

        // 4. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        const participants = await Promise.all(
            uniqueIds.map(async (userId) => {
                const userRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    return null;
                }

                const userData = userSnap.data();
                return {
                    id: userId,
                    name: userData.name || 'ÐÐ½Ð¾Ð½Ð¸Ð¼',
                    email: userData.email || '',
                    role: userData.role || 'student',
                    avatar: userData.avatar || null
                };
            })
        );

        // 5. Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ null (ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½)
        return participants.filter(p => p !== null);

    } catch (error) {
        console.error("Error in getChatParticipants:", error);
        return [];
    }
};

// Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
export const getUserChats = async (userId, isTeacher, isAdmin = false) => {
    try {
        const coursesRef = collection(db, 'courses');

        // Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ÐºÑƒÑ€ÑÑ‹, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ â€” ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚
        const studentQuery = query(coursesRef, where('students', 'array-contains', userId));
        const studentCoursesSnapshot = await getDocs(studentQuery);

        // Ð•ÑÐ»Ð¸ Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ â€” Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð°ÐºÐ¶Ðµ ÐºÑƒÑ€ÑÑ‹ Ð¿Ð¾ teacherId
        let allDocs = [...studentCoursesSnapshot.docs];

        if (isTeacher) {
            const teacherQuery = query(coursesRef, where('teacherId', '==', userId));
            const teacherCoursesSnapshot = await getDocs(teacherQuery);

            // ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¿Ð¾ course ID
            const courseMap = new Map();
            allDocs.forEach(doc => courseMap.set(doc.id, doc));
            teacherCoursesSnapshot.docs.forEach(doc => courseMap.set(doc.id, doc));
            allDocs = Array.from(courseMap.values());
        }

        // Ð¡Ð±Ð¾Ñ€ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÐºÑƒÑ€ÑÑƒ
        const chats = await Promise.all(
            allDocs.map(async (courseDoc) => {
                const courseData = courseDoc.data();
                const courseId = courseDoc.id;

                // ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
                let lastMessage = '';
                try {
                    const messagesQuery = query(
                        collection(db, 'courses', courseId, 'messages'),
                        orderBy('timestamp', 'desc'),
                        limit(1)
                    );
                    const messagesSnapshot = await getDocs(messagesQuery);

                    if (!messagesSnapshot.empty) {
                        const lastMsgData = messagesSnapshot.docs[0].data();
                        lastMessage = lastMsgData.text || '';

                        if (lastMsgData.fileType) {
                            lastMessage = lastMsgData.fileType === 'image'
                                ? 'ðŸ“· Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ'
                                : 'ðŸ“ Ð¤Ð°Ð¹Ð»';
                        }
                    }
                } catch (e) {
                    console.error(`Error loading messages for ${courseId}:`, e);
                }

                // Ð˜Ð¼Ñ Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ
                let teacherName = 'ÐŸÑ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»ÑŒ';
                try {
                    if (courseData.teacherId) {
                        const teacherDoc = await getDoc(doc(db, 'users', courseData.teacherId));
                        if (teacherDoc.exists()) {
                            teacherName = teacherDoc.data().name || teacherName;
                        }
                    }
                } catch (e) {
                    console.error(`Error loading teacher for ${courseId}:`, e);
                }

                return {
                    id: courseId,
                    name: courseData.title || 'Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ',
                    description: courseData.description || '',
                    lastMessage,
                    teacher: teacherName,
                    unreadCount: 0,
                    createdAt: courseData.createdAt?.toDate?.() || new Date()
                };
            })
        );

        // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
        return chats.sort((a, b) => b.createdAt - a.createdAt);

    } catch (error) {
        console.error("Error in getUserChats:", error);
        return [];
    }
};